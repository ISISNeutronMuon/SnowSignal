image: python:latest

stages:
  - format-lint
  - test
  - build
  - deploy

.before_script_template: &before_script_template
  before_script: 
    - echo $NAME
    - python -m pip install --upgrade pip
    - pip install -r src/requirements.txt
    - pip install -r test/requirements.txt
    - python -V

format:
  <<: *before_script_template
  stage: format-lint
  script:
    - black --line-length 120 --check --diff --color ./src

lint:
  <<: *before_script_template
  stage: format-lint
  script:
    - flake8 --ignore E501,W503 ./src

.test_job_template: &test_job_template
  <<: *before_script_template
  stage: test
  image: "python:$VERSION"
  parallel:
    matrix:
      - VERSION: ['3.10', '3.11']

unit-test:
  <<: *test_job_template
  script:
    - python -m coverage run --source=. -m pytest tests/unit/
    - coverage report -m
    - coverage xml
  rules:
    - allow_failure: true # Only the later tests must succeed
  coverage: '/TOTAL.*\s+(\d+\%)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ./coverage.xml

Run unittests:
  <<: *before_script_template
  stage: test
  script:
    - python -m coverage run --source=. -m unittest discover
    - coverage report -m
    - coverage xml
  coverage: '/TOTAL.*\s+(\d+\%)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ./coverage.xml

Rebuild Image: 
  <<: *before_script_template
  stage: build
  when: on_success
  image: docker
  variables:
    DOCKER_TAG: $CI_COMMIT_REF_NAME
  services:
    - docker:dind
  script:
    - echo $NAME
    - docker build -t snowsignal src
    - docker login https://harbor.stfc.ac.uk -u $DOCKER_REG_NAME --password $DOCKER_REG_TOKEN
    - echo Build Identifiers - ${NAME}:$DOCKER_TAG
    - docker build -t harbor.stfc.ac.uk/isis-accelerator-controls/snowsignal:$DOCKER_TAG src
    - docker push harbor.stfc.ac.uk/isis-accelerator-controls/snowsignal:$DOCKER_TAG

Deploy Image:
  stage: deploy
  when: on_success
  script: 
    - apk add curl
    - curl -X POST $WEBHOOK_APP
